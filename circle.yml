machine:
  node:
    version: 6.1.0
test:
  pre:
    - NODE_ENV=test make client/config/index.js:
        parallel: true
  override:
    - echo "CIRCLE_BRANCH is $CIRCLE_BRANCH " | grep "master" && ./bin/run-lint --format=./bin/eslint-formatters-calypso/src/formatters/parsing-errors.js :
        parallel: true
        files:
          - client/**/*.js
          - client/**/*.jsx
          - server/**/*.js
          - server/**/*.jsx
    - echo "CIRCLE_BRANCH is $CIRCLE_BRANCH " | grep -v "master" && ./bin/run-lint --format=./bin/eslint-formatters-calypso/src/formatters/lines-modified-and-specific-rules.js $(git diff --name-only $(git merge-base $(git rev-parse --abbrev-ref HEAD) origin/master)..HEAD *js *jsx)
    - MOCHA_FILE=./test-results-client.xml npm run test-client -- -R mocha-junit-reporter -t $CIRCLE_NODE_TOTAL -i $CIRCLE_NODE_INDEX:
        parallel: true
    - MOCHA_FILE=./test-results-server.xml npm run test-server -- -R mocha-junit-reporter -t $CIRCLE_NODE_TOTAL -i $CIRCLE_NODE_INDEX:
        parallel: true
    - MOCHA_FILE=./test-results-test.xml npm run test-test -- -R mocha-junit-reporter -t $CIRCLE_NODE_TOTAL -i $CIRCLE_NODE_INDEX:
        parallel: true
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/ && find . -type f -regex  "./test-results.*\.xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;:
        parallel: true
    - if [[ $CIRCLE_BRANCH == "master" ]]; then make translate; mkdir $CIRCLE_ARTIFACTS/translate; cp calypso-strings.pot $CIRCLE_ARTIFACTS/translate/calypso-strings.pot; fi;
